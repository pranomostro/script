#!/usr/bin/env rc

cd /mnt/backup

name=`{date '+%Y-%m-%d'.tar.gz}
last=`{stat --format'=%Y %n' * | sort -n | awk 'END { print($2) }'}
month=`{date '+%m'}
lastmonth=`{echo $last | sed 's/^[0-9]\+-\([0-9]\+\).*/\1/'}

if(test -f $name || test -d /mnt/backup/tmp)
	exit 0

mkdir tmp

if(! ~ $month $lastmonth)
	cp -R /home/$USER/ tmp/
if not
	cgdc $last /home/$USER/ /mnt/backup/tmp/

test -f tmp/.gnupg/random_seed && rm tmp/.gnupg/random_seed

cd tmp
tar -czf $name *
mv $name ..
cd ..
rm -rf tmp
chmod 0600 $name
