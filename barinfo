#!/usr/bin/env rc

sep=' |  '

while(true){
	echo -n ' brightness:' `{cat /sys/class/backlight/radeon_bl0/brightness} $sep
	echo -n 'battery:' `{acpi | field 4 | sed 's/,$//'} $sep
	echo -n 'volume:' `{amixer -M get Master | grep '%' | field 4 | tr -d '\n[]'} $sep
	echo -n 'date:' `{date +'%Y-%m-%d'} $sep
	echo -n 'time:' `{date +'%H:%M:%S'} $sep
	echo -n 'metrictime:' `{echo '('`{date +'%H'}'*3600+' `{date +'%M'}'*60+' `{date +'%S'} ')/86.4' | bc} $sep
	echo -n 'usedram:' `{free -m | sed '1d; 3d' | field 3} $sep
	echo -n 'load:' `{cat /proc/loadavg | field 1} $ sep
	echo 'play:' `{
		ae=''
		pbs=''
		oggproc=`{ps -A | grep 'ogg123' | field 1}
		pbs=`{test -e /tmp/sad-sock && echo 'status playback' | nc -U /tmp/sad-sock | awk '{ print($2) }'}
		if(! ~ $oggproc ''){
			cd /proc/$oggproc/fd;
			ls |
			xargs -n 1 readlink |
			grep '\.ogg$' |
			xargs basename |
			sed 's/\.ogg$//' |
			ell 40
			ae='1'
		}
		if(! ~ $pbs '' && ! ~ $pbs 'stop' && ! ~ $ae '1'){
			id=`{echo 'status songid' | nc -U /tmp/sad-sock | head -1 | awk '{ print($2) }'}
			echo 'playlist' | nc -U /tmp/sad-sock | grep '^'$id':' | awk '{ print($2) }' |
			xargs basename | sed 's/\.ogg$//' | ell 40
			ae='1'
		}
		if(! ~ $ae '1')
			echo nothing
	}
	sleep 1
}
